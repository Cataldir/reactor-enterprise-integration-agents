version: '3.8'

services:
  # Padrão 1: Message Queue Monitor and Executor
  message-queue:
    build:
      context: .
      dockerfile: src/services/message_queue/Dockerfile
      target: development
    container_name: service-message-queue
    ports:
      - "8000:8000"
    environment:
      - AZURE_AI_PROJECT_ENDPOINT=${AZURE_AI_PROJECT_ENDPOINT}
      - AZURE_TENANT_ID=${AZURE_TENANT_ID}
      - AZURE_CLIENT_ID=${AZURE_CLIENT_ID}
      - AZURE_CLIENT_CERTIFICATE_PATH=${AZURE_CLIENT_CERTIFICATE_PATH}
      - EVENTHUB_CONNECTION_STRING=${EVENTHUB_CONNECTION_STRING}
      - EVENTHUB_NAME=${EVENTHUB_NAME}
      - MODEL_DEPLOYMENT_NAME=${MODEL_DEPLOYMENT_NAME:-gpt-4}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./src/services/message_queue:/app/src/services/message_queue
      - ./src/shared:/app/src/shared
      - ${AZURE_CLIENT_CERTIFICATE_PATH_HOST}:/app/certs/azure-sp.pem:ro
    networks:
      - integration-network
    restart: unless-stopped

  # Padrão 2: Pipes and Filters com Capacidades Cognitivas
  pipes-filters:
    build:
      context: .
      dockerfile: src/services/pipes_filters/Dockerfile
      target: development
    container_name: service-pipes-filters
    ports:
      - "8001:8001"
    environment:
      - AZURE_AI_PROJECT_ENDPOINT=${AZURE_AI_PROJECT_ENDPOINT}
      - AZURE_TENANT_ID=${AZURE_TENANT_ID}
      - AZURE_CLIENT_ID=${AZURE_CLIENT_ID}
      - AZURE_CLIENT_CERTIFICATE_PATH=${AZURE_CLIENT_CERTIFICATE_PATH}
      - EVENTHUB_CONNECTION_STRING=${EVENTHUB_CONNECTION_STRING}
      - EVENTHUB_NAME=${EVENTHUB_NAME}
      - MODEL_DEPLOYMENT_NAME=${MODEL_DEPLOYMENT_NAME:-gpt-4}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./src/services/pipes_filters:/app/src/services/pipes_filters
      - ./src/shared:/app/src/shared
      - ${AZURE_CLIENT_CERTIFICATE_PATH_HOST}:/app/certs/azure-sp.pem:ro
    networks:
      - integration-network
    restart: unless-stopped

  # Padrão 3: Publish/Subscribe com Agentes de IA
  pubsub:
    build:
      context: .
      dockerfile: src/services/pubsub/Dockerfile
      target: development
    container_name: service-pubsub
    ports:
      - "8002:8002"
    environment:
      - AZURE_AI_PROJECT_ENDPOINT=${AZURE_AI_PROJECT_ENDPOINT}
      - AZURE_TENANT_ID=${AZURE_TENANT_ID}
      - AZURE_CLIENT_ID=${AZURE_CLIENT_ID}
      - AZURE_CLIENT_CERTIFICATE_PATH=${AZURE_CLIENT_CERTIFICATE_PATH}
      - EVENTHUB_CONNECTION_STRING=${EVENTHUB_CONNECTION_STRING}
      - EVENTHUB_NAME=${EVENTHUB_NAME}
      - MODEL_DEPLOYMENT_NAME=${MODEL_DEPLOYMENT_NAME:-gpt-4}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./src/services/pubsub:/app/src/services/pubsub
      - ./src/shared:/app/src/shared
      - ${AZURE_CLIENT_CERTIFICATE_PATH_HOST}:/app/certs/azure-sp.pem:ro
    networks:
      - integration-network
    restart: unless-stopped

  # Padrão 4: Mensagens de Comando com Pipelines Assíncronos
  command-messages:
    build:
      context: .
      dockerfile: src/services/command_messages/Dockerfile
      target: development
    container_name: service-command-messages
    ports:
      - "8003:8003"
    environment:
      - AZURE_AI_PROJECT_ENDPOINT=${AZURE_AI_PROJECT_ENDPOINT}
      - AZURE_TENANT_ID=${AZURE_TENANT_ID}
      - AZURE_CLIENT_ID=${AZURE_CLIENT_ID}
      - AZURE_CLIENT_CERTIFICATE_PATH=${AZURE_CLIENT_CERTIFICATE_PATH}
      - EVENTHUB_CONNECTION_STRING=${EVENTHUB_CONNECTION_STRING}
      - EVENTHUB_NAME=${EVENTHUB_NAME}
      - MODEL_DEPLOYMENT_NAME=${MODEL_DEPLOYMENT_NAME:-gpt-4}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./src/services/command_messages:/app/src/services/command_messages
      - ./src/shared:/app/src/shared
      - ${AZURE_CLIENT_CERTIFICATE_PATH_HOST}:/app/certs/azure-sp.pem:ro
    networks:
      - integration-network
    restart: unless-stopped

networks:
  integration-network:
    driver: bridge

# Volumes para dados persistentes (se necessário)
volumes:
  shared-data:
